<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- 上述3个meta标签*必须*放在最前面，任何其他内容都*必须*跟随其后！ -->
    <meta name="description" content="home">
    <meta name="author" content="NI Tianwei">
    <link rel="icon" href="img/favicon.ico">
    <title>Anonymous Forum Home</title>
 
    <!-- Bootstrap core CSS -->
    <link href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <link href="css/home.css" rel="stylesheet">
	<link href="css/buttons.css" rel="stylesheet">
	<link href="css/fileinput.css" rel="stylesheet">

	</head>
  	<body>
    <nav class="navbar navbar-inverse navbar-fixed-top">
        <div class="container">
        	<div class="navbar-header">
            	<button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
              		<span class="sr-only">Toggle navigation</span>
              		<span class="icon-bar"></span>
              		<span class="icon-bar"></span>
              		<span class="icon-bar"></span>
            	</button>
            	<a class="navbar-brand" href="home.html"><img src="img/logo.png" height="50px" width="100px"></a>
          	</div>
        	<div id="navbar" class="navbar-collapse collapse">
            	<ul class="nav navbar-nav navbar-right">
					<li><a href="user.html" class="btn btn-success btn-lg active" id="personal" role="button">Personal Info &raquo;</a></li>
					<!-- href = "user.html?uid=xxx" -->
            	</ul> 
            <!-- <form class="navbar-form navbar-right">
              <div class="form-group">
                <input type="text" placeholder="Username" class="form-control">
              </div>
              <div class="form-group">
                <input type="password" placeholder="Password" class="form-control">
              </div>
              <button type="submit" class="btn btn-success">Sign in</button>
            </form> -->
        	</div><!--/.navbar-collapse -->
        </div>
    </nav>
  
      <!-- Main jumbotron for a primary marketing message or call to action -->
    <div class="jumbotron">
        <div class="container">
          	<h1>Hello, Anonym!</h1>
          	<p>This is an anonymous forum designed by PKU students.</p>
          	<p><a href="about.html" class="button button-glow button-rounded button-raised button-primary">Learn more &raquo;</a></p>
        </div>
    </div>
	
    <div class="container">
		<table class="table table-hover" id="table">
			<caption><h2>Trending</h2></caption>
			<thead>
				<tr class="warning row">
					<th class="col-md-7">Thread</th>
					<th class="col-md-1">Stat</th>
					<th class="col-md-2">Post</th>
					<th class="col-md-2">Last</th>
				</tr>
			</thead>
			<tbody id="tbody">
			  	<!-- <tr class="row">
				<th class="col-md-7">
					<p><a href="./tid?" class="thread-title">【FOR 葛格】主人，精致的宠物猪猪，要不要领养一只</a></p>
					<p class="thread-text">这是一只有些精致的宠物猪猪，喜欢打扮自己的男孩子要不要领养一只呢？...</p>
				</th>
				<td class="col-md-1 thread-number">
					<p><i class="glyphicon glyphicon-plus"></i> 79</p>
					<p><i class="glyphicon glyphicon-eye-open"></i> 322</p>
				</td>
				<td class="col-md-2">
					<p class="thread-post"><i class="glyphicon glyphicon-user"></i><a href="./uid?" class="thread-post"> dorisxiaoyao</a></p>
					<p><i class="glyphicon glyphicon-calendar"></i> 2018-05-20 16:40:23</p>
				</td>
				<td class="col-md-2">
					<p class="thread-last"><i class="glyphicon glyphicon-user"></i><a href="./uid?" class="thread-last"> dorisxiaoyao</a></p>
					<p><i class="glyphicon glyphicon-calendar"></i> 2018-05-21 00:38:11</p>
				</td>
				</tr> -->
			</tbody>
		</table>
		<form enctype="multipart/form-data">
			<h2>Start A New Post</h2>
			<div class="form-group">
			  	<label>Title</label>
			  	<input type="text" class="form-control" placeholder="Title" id="post-title" required>
			</div>
			<div class="form-group">
				<label>Text</label>
				<textarea class="form-control" rows="8" placeholder="Please input text ..." id="post-text" required></textarea>
			</div>
			<input id="post-file" name="file" type="file" multiple>
			<!-- <form id="form1">
				图片id<input type="text" name="id" id="picid" >
				图片名称:<input type="text" name="picName" >  
				<input type="button" id="savePic">保存</button>          
			</form> -->
			<button type="submit" class="button button-glow button-rounded button-highlight">Submit &raquo;</button>
		</form>

        <hr>
        <footer>
          	<p>&copy; 2018 PKU CS.</p>
        </footer>
	</div> <!-- /container -->
    <!-- jQuery (Bootstrap 的所有 JavaScript 插件都依赖 jQuery，所以必须放在前边) -->
    <script src="js/jquery.js"></script>
    <!-- 加载 Bootstrap 的所有 JavaScript 插件。你也可以根据需要只加载单个插件。 -->
	<script src="https://cdn.bootcss.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
	<script src="js/bootstrapPager.js"></script>
	<script src="js/fileinput.js"></script>
    <script>

		function getUrlParam(name) {   
				var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)"); //构造一个含有目标参数的正则表达式对象   
				var r = window.location.search.substr(1).match(reg);  //匹配目标参数   
				if (r != null) return unescape(r[2]);   
				return null; //返回参数值   
		} 

		$(function(){ // all be ready

			var page_name = 'page';
			var page_size = 2;
			var page_num = getUrlParam(page_name); // 获取page_num，便于分页
			if (page_num == null) page_num = 1;

			$.ajax({
				url:"json/home.json",  // home.html?page=page_num
				beforeSend: function(xhr){  // te be commented
					if (xhr.overrideMimeType) {	
						xhr.overrideMimeType("application/json");
					}
				},
				type:"get",
				dataType:"json",
				contentType: "application/json", 
				success: function(result) {
					// console.log(result);  
					if (result.status == 1) {
						alert('json status false');
						return;
					}
					var thread_array = result.data;
					var x = Pager({
						totalCount: thread_array.length, //总条数
						pageSize: page_size,    //每页显示6条内容，默认10
						buttonSize: 6,   //显示6个按钮，默认10
						pageParam: page_name,   //页码的参数名默认为'page'
						className:'pagination',    //分页的样式
						prevButton:'Prev',       //上一页按钮
						nextButton:'Next',       //下一页按钮
						firstButton:'First',      //第一页按钮
						lastButton:'Last',       //最后一页按钮
					});
					$("#table").after(x);
					for (var i = (page_num - 1) * page_size; i < thread_array.length && i < page_num * page_size; i += 1) { // 需要修改，后端分页
						$("#tbody").append(
							"<tr class='row'>" +
							"<th class='col-md-7'>" + 
							"<p><a href='thread.html?tid=" + thread_array[i].tid + "' class='thread-title'>" + thread_array[i].title + "</a></p>" +
							"<p class='thread-text'>" + thread_array[i].text + "</p></th>" + 
							"<td class='col-md-1 thread-number'>" +
							"<p><i class='glyphicon glyphicon-plus'></i> "+ thread_array[i].re +"</p>" + 
							"<p><i class='glyphicon glyphicon-eye-open'></i> "+ thread_array[i].view +"</p></td>" + 
							"<td class='col-md-2'>" + 
							"<p class='thread-post'><i class='glyphicon glyphicon-user'></i> " + thread_array[i].pid + "</p>" + 
							"<p><i class='glyphicon glyphicon-calendar'></i> " + thread_array[i].post + "</p></td>" +
							"<td class='col-md-2'>" + 
							"<p class='thread-last'><i class='glyphicon glyphicon-user'></i> " + thread_array[i].lid + "</p>" + 
							"<p><i class='glyphicon glyphicon-calendar'></i> " + thread_array[i].last + "</p></td>" + 
							"</tr>");
					}
				},
				error: function(XMLHttpRequest, textStatus, errorThrown) {
					alert(XMLHttpRequest.status);
					alert(XMLHttpRequest.readyState);
					alert(textStatus);
				},
			})

			$('#post-file').fileinput({//初始化上传文件框
			        showUpload : false,
			        showRemove : false,
			        uploadAsync: true,
			        uploadLabel: "Upload",//设置上传按钮的汉字
			        uploadClass: "btn btn-primary",//设置上传按钮样式
			        showCaption: false,//是否显示标题
			        // language: "",//配置语言
			        uploadUrl: "BannerPicAction!addPicture.action", 
			        maxFileSize : 0,
			        maxFileCount: 5,/*允许最大上传数，可以多个，当前设置单个*/
			        enctype: 'multipart/form-data',
			        //allowedPreviewTypes : [ 'image' ], //allowedFileTypes: ['image', 'video', 'flash'],
			        // allowedFileExtensions : ["jpg", "png","gif"],/*上传文件格式*/
			        msgFilesTooMany: "Number of your files ({n}) is over maximum of ({m}).",
			        dropZoneTitle: "Please Drag your files here", 
			        dropZoneClickTitle: " or Click here to upload your files",
			        showBrowse: false,
			        browseOnZoneClick: true,
			        slugCallback : function(filename) {
			            return filename.replace('(', '_').replace(']', '_');
			        }
			    });
			    //上传文件成功，回调函数 
			    $('#post-file').on("filepreupload", function(event, data, previewId, index) {     //上传中  
			                var form = data.form, files = data.files, extra = data.extra,  
			                response = data.response, reader = data.reader;  
			                console.log('文件正在上传',data);
			                console.log(event);
			                console.log(previewId);
			                console.log(index);
			    }); 
			    $('#post-file').on("fileuploaded", function(event, data, previewId, index) {
			    console.log("hello")
			    var result = data.response; //后台返回的json
			    //console.log(result.status);
			    //console.log(result.id);
			    $('#picid').val(result.id);//拿到后台传回来的id，给图片的id赋值序列化表单用
			    //如果是上传多张图
			    /*
			    //计数标记，用于确保全部图片都上传成功了，再提交表单信息
			    var fileCount = $('#post-file').fileinput('getFilesCount');
			    if(fileCount==1){
			    $.ajax({//上传文件成功后再保存图片信息
			        url:'BannerPicAction!savaForm.action',
			        data:$('#form1').serialize(),//form表单的值
			        success:function(data,status){
			            ...
			        },
			        cache:false,                    //不缓存
			    });
			    }
			    */
			    $.ajax({//上传文件成功后再保存图片信息
			        url:'BannerPicAction!savaForm.action',
			        type:'post',
			        dataType:'json',
			        data:$('#form1').serialize(),//form表单的值
			        success:function(data,status){
			            if (status == "success") {
						
			                if(data.status == "success"){//提交成功
							
			                    //跳转回添加页面
							
			                }else{
			                    alert("添加失败,编码的错误!");
			                }
						
			                } else {
			                    alert("添加失败,ajax请求返回失败!");
			            }
			        },
			        cache:false,                    //不缓存
			    });
			    });
			
			    // $('#savePic').on('click',function (){// 提交图片信息 //
			    //     //先上传文件，然后在回调函数提交表单
			    //     $('#post-file').fileinput('upload');
				
				// });  
				
			$("form").submit(function(result) {
				$('#post-file').fileinput('upload');
    			var new_post = {
					"title": $("#post-title").val(),
					"text": $("#post-text").val(),
					"pid": "pid",  // needs server
					"time": Date()
				}
				console.log(new_post);
				$.ajax({
					type: "get",
					url: "thread.html?post", // url?
					data: new_post,
					dataType: 'json',
					contentType: 'application/json; charset=utf-8',
					success: function (result) {
						if (result.status == 0) {
							console.log("服务器接收成功！");
							window.location.href = "thread.html?tid=" + result.tid; // redirect
						}
						else {
							console.log("服务器接收数据失败！");
							window.location.reload();
						}
					},
					error: function () {
						console.log("程序运行出错！");
						window.location.reload();
					}
            	});
			  });
	}); 
    </script>

  </body>
</html>